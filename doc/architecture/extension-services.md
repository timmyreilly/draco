# Extension services

**Extension services** provide a generic, extensible interface for securely exposing external dependencies to extensions at execution-time. **Extension services** can be nearly anything including –

- Centralized logging and monitoring platforms like [Azure Monitor](https://azure.microsoft.com/en-us/services/monitor/)
- Client hardware like printers, barcode scanners, etc.
- Internal and external APIs
- Configuration information and secrets

**Extension services** are uniquely identifiable and independently versioned.

![Extension services](/doc/images/arch-extension-services.JPG)

## A simple example

[Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview), a feature of [Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/overview), is an extensible Application Performance Management (APM) service for developers and DevOps professionals. In order to simplify centralized logging and monitoring across its catalog of extensions, the host will be creating a dedicated [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) resource for each supporting extension.

At execution-time, Draco should provide supporting extensions with all the information they need to access the appropriate [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) resource. In order to authenticate to [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview), each extension must first obtain a corresponding instrumentation key.

In order to accomplish this, the host will register a new **extension service**, **app-insights/v1**, with its hub that, given an execution request, will identify the appropriate [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) resource and provide the corresponding instrumentation key through an execution-specific **[service context](#service-context)**. The **[service context](#service-context)**, including the appropriate instrumentation key, will be generated by the **app-insights/v1 [service provider](#service-providers)** then provided to the extension by the **[execution adapter](execution-models.md)** like this –

```json
"services": {
  "app-insights/v1": {
    "instrumentationKey": "d9eb1b7c-e325-4f69-8203-dab1cdce976e"
  }
}
```

At execution-time, the extension uses the **[service context](#service-context)** provided by **[execution adapter](execution-models.md)** to access the appropriate [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) resource and publish logs and metrics. Depending on business need, both the host and extension publisher can leverage the [Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) portal to monitor extension health across all executions through a single pane of glass.

## Key concepts

### Service context

A **service context** is an immutable, execution-specific JSON object that contains all the information that an extension needs to consume an **extension service**. The **service context** schema is determined by the service itself. Any extension that supports a given **extension service** is expected to be able to parse its corresponding **service context**. Depending on use case, the **service context** may contain information needed to access an external service (logging and monitoring platforms, APIs, etc.) or it may directly contain information needed during execution (configuration information, secrets, etc.) **Service contexts** are generated by **[service providers](#service-providers)**.

### Service providers

Each **extension service** has a corresponding **service provider**. The **service provider's** job, given an execution request, is to generate an appropriate **[service context](#service-context)** which can then be used by the extension to access the service.

An [example **service provider**](/src/draco/tests/IntegrationTests.HowdyService/HowdyServiceProvider.cs) is included in the Draco source.

**Service providers** can be registered [directly through the execution API](/src/draco/api/Execution.Api/Modules/Factories/ExecutionServiceProviderFactoryModule.cs) or [through the stand-alone execution agent](/src/draco/core/Agent/ExecutionAdapter.ConsoleHost/Modules/ExecutionServiceProviderFactoryModule.cs).

> **Best practice:** To enable even looser coupling and frictionless, zero-downtime updates, Draco provides [a standardized mechanism for wrapping **service providers** in their own APIs](/src/draco/api/ExtensionService.Api) which can then be deployed independently of the execution API and/or execution console. This also makes it easier to create **service providers** in cases where C# is not the preferred programming language.

#### Implementation

Under the hood, **service providers** implement the [IExecutionServiceProvider interface](/src/draco/core/Services/Interfaces/IExecutionServiceProvider.cs). If you're creating new **service providers** in C#, this is the recommended approach even if you're planning on wrapping the **service provider** within its own API as highlighted in the best practice above. Using a common interface gives you greater flexibility in how you deploy **service providers**.

### Putting it all together

When an extension is registered with Draco, the extension provides a list of **extension services** that it natively supports. At execution-time, the Draco **[execution adapter](execution-models.md)** compares this list of supported services against its own internal list of registered **[service providers](#service-providers)**. For each service that appears in both lists (that is, it's supported by both the extension and the **[execution adapter](execution-models.md)**), the **[execution adapter](execution-models.md)** obtains an execution-specific **[service context](#service-context)** from the appropiate **[service provider](#service-providers)**. This **[service context](#service-context)** contains all the information that the extension needs to consume the service.
